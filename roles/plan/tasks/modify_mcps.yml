---
# Gather Nodes
- name: Gather Node Info
  kubernetes.core.k8s_info:
    api_version: "v1"
    kind: Node
  register: nodes

# Set Control Plane and Work Plane Nodes
- name: Set Node Facts
  ansible.builtin.set_fact:
    cp_nodes: "{{ nodes | community.general.json_query(cp_query) }}"
    wp_nodes: "{{ nodes | community.general.json_query(wp_query) }}"
  vars:
    cp_query: resources[?(metadata.labels."node-role.kubernetes.io/master"=='')]
    wp_query: resources[?(metadata.labels."node-role.kubernetes.io/worker"=='')]

# Gather Machine Config Pools
- name: Gather Control Plane Machine Config Pools
  kubernetes.core.k8s_info:
    api_version: "machineconfiguration.openshift.io/v1"
    kind: MachineConfigPool
  register: machineconfigpools

# Set Control Plane Pool and Work Plane Pools
- name: Set MCP Facts
  ansible.builtin.set_fact:
    cp_mcp_names: "{{ machineconfigpools | community.general.json_query(cp_query) }}"
    wp_mcp_names: "{{ machineconfigpools | community.general.json_query(wp_query) }}"
  vars:
    cp_query: >-
      resources[?(metadata.labels."pools.operator.machineconfiguration.openshift.io/master"=='')].metadata.name
    wp_query: >-
      resources[?!(metadata.labels."pools.operator.machineconfiguration.openshift.io/master"==''
      ||
      metadata.labels."pools.operator.machineconfiguration.openshift.io/canary"=='')].metadata.name

# Pause Worker Pools
- name: Pause Worker Pools
  kubernetes.core.k8s:
    api_version: "machineconfiguration.openshift.io/v1"
    kind: MachineConfigPool
    name: "{{ item }}"
    definition:
      spec:
        paused: true
  loop: "{{ wp_mcp_names | list }}"
